# Backend Data & Logic Guide (v1.0)
**Date:** 2026-02-17
**Author:** VibeAlgoLab

## 1. Data Pipeline (`macro_analyzer.py`)
This project relies on **Python-based data processing**. The `macro_analyzer.py` script fetches data from external APIs, performs AI analysis, and saves the results as JSON files.

### A. Key Modules
- **Data Collection:** Yahoo Finance (`yfinance`), Google Gemini (`utils/gemini_utils.py`)
- **Analysis:** Pandas (`df.corr()`, `df.pct_change()`)
- **Storage:** `data/*.json` (NoSQL-like storage)

### B. Execution Flow
1.  **Market Data:** Fetch index (S&P 500, Nasdaq) and sector data.
2.  **AI Analysis:** Call Gemini API (Prompt: "Generate a daily market report based on this data...").
3.  **Risk Calc:** Calculate correlation coefficients and volatility.
4.  **Save:** Overwrite JSON files in the `data/` folder.

## 2. API Design (Next.js Routes)
The Frontend communicates with the Backend (JSON Data) via `src/app/api` routes.

- **GET `/api/market`**: Reads JSON files from `data/` and returns a consolidated response.
- **POST `/api/market`**: (Optional) Handles real-time analysis requests for specific tickers (calls `yfinance`).

### Code Example (Route Handler Pattern)
```typescript
import { NextResponse } from 'next/server';
import fs from 'fs/promises';
import path from 'path';

export async function GET() {
  try {
    const dataPath = path.join(process.cwd(), 'data', 'macro_analysis.json');
    const data = await fs.readFile(dataPath, 'utf-8');
    return NextResponse.json(JSON.parse(data));
  } catch (error) {
    return NextResponse.json({ error: 'Data not found' }, { status: 404 });
  }
}
```

## 3. AI Integration (Gemini Implementation)
`utils/gemini_utils.py` follows this structure:
- **Model:** `gemini-1.5-flash` (Optimized for speed) or `gemini-1.5-pro` (Deep analysis).
- **Retry Logic:** Exponential Backoff applied on API failure.
- **Prompt Engineering:**
    - Role: "You are a senior financial analyst provided with the following market data..."
    - Output Format: "Structure the response with clear headers (###) and bullet points."

## 4. Data Storage Structure (File-based DB)
- `macro_analysis.json`: Full report text and metadata
- `sector_heatmap.json`: Sector percentage changes (For Heatmap)
- `portfolio_risk.json`: Risk matrix and portfolio status

---
*This document helps understand backend logic and reproduce data flows/script execution.*
